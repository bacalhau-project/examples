<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>K8s Client</title>
    <script src="https://kit.fontawesome.com/4dc51004da.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>

<body class="container">
    <h1>
        JustIcons Dashboard
    </h1>

    <style>
        #all-nodes {
            display: grid;
            grid-template-columns: repeat(6, 200px);
            row-gap: 28px;
            column-gap: 10px;
        }

        .fa-solid {
            width: 18.75px;
            text-align: center;
            font-size: large;
        }

        .node-obj-box>div {
            border: 1px solid red;
            height: 100px;
            width: 160px;
            padding: 0px;
            margin: 0px 4px;
        }

        .node-obj-box>span {
            width: 160px;
        }

        .node-obj {
            font-family: 'Droid Sans Mono';
        }

        .label {
            padding: 10px;
            font-size: 15px;
            border-radius: 0.45em;
            height: 44px;
            color: white;
            display: block;
            margin: 6px 0px;
        }

        .center {
            margin: auto;
            display: block;
            width: 50%;
            text-align: center;
        }

        .region-box-label {
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: navy;
            border-radius: 0.15em;
            line-height: 8px;
            height: 32px;
            padding: 10px;
            width: 160px;
            vertical-align: middle;
        }

        #all-nodes-div {
            width: 100%;
            height: 100%;
            margin: 20px 5px 20px 5px;
        }

        .region-box {
            display: grid;
            grid-template-columns: repeat(1, 200px);
            margin: 10px;
            border: black 1px solid;
            border-radius: 4px;
            align-content: center;
            padding: 10px 10px;
        }

        #all-nodes {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
    </style>

    <div>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
    </div>

    <div id="all-nodes-div">
        <div id="all-nodes">
        </div>
    </div>

    <script>
        // Query the given endpoint for the server data
        var hostname = "127.0.0.1:9595";

        // A list of server objects that will be updated by the query
        // The server object looks like this:
        // {color: '#6638f0', hostname: 'M2-Max.local', icon: 'fa-phone-square-alt', iconID: 'node-number-M2-Max.local-icon', ip: '127.0.0.1'}
        var servers = {};

        document.getElementById('start').addEventListener('click', function () {
            intervalId = setInterval(function () {

                // Every 0.2 seconds, query the hostname 5 times        
                for (var i = 0; i < 5; i++) {
                    // create a new worker thread
                    worker = new Worker("/static/httpworker.js")

                    // pass data to worker thread
                    worker.postMessage(hostname)

                    // listen to any data passed from worker thread
                    worker.onmessage = (event) => {
                        // console.log("Received data from worker thread -- :" + JSON.stringify(event.data, undefined, 2))
                        if (event.data) {
                            servers[event.data.hostname] = event.data
                        }
                        for (var key in servers) {
                            // console.log("working on key: " + key)
                            if (servers.hasOwnProperty(key)) {
                                var server = servers[key];
                                var hashCode = server.hashCode;

                                var regionBox = $('#region-' + server.region);
                                if (regionBox.length == 0) {
                                    $('#all-nodes').append(" \
<div class='region-box-container' id='region-container-" + server.region + "'> \
<span class='region-box-label center'> " + server.region + "</span>\
<div class='region-box' id='region-" + server.region + "'> \
</div> \
</div>")
                                    regionBox = $('#region-' + server.region);
                                }


                                var nodeName = "node-" + hashCode;
                                if ($('#' + nodeName).length == 0) {
                                    regionBox.append(" \
                <div class='node-obj-box'> \
                <span class='label label-info node-obj' id='"+ nodeName + "' \
                style='background-color: "+ server.color + "; border-color: " + server.color + "; border-style: solid;' \
                data-ip='"+ hashCode + "'> \
                node-"+ hashCode + " <span id='node-" + hashCode + "-icon' \
                class='fa-solid "+ server.icon + "'></span> \
                </span> \
                </div>");
                                }
                                else {
                                    $("#" + nodeName).css("background-color", server.color)
                                        .finish()
                                        .css("border-color", server.color)
                                        .css("color", "#FFFFFF")
                                        .fadeTo(0, 0.50)
                                        .fadeTo(200, 1)
                                        .addClass('alive-node');
                                    $("#node-" + hashCode + "-icon").removeClass().toggleClass("fa-solid " + server.icon);
                                }
                            }
                        }
                    }
                }
                // Loop through each server in the 'servers' object
                for (var key in servers) {
                    if (servers.hasOwnProperty(key)) {
                        var server = servers[key];

                        // Create a server.jinja element for each server
                        var serverElement = document.createElement('div');
                        serverElement.innerHTML = `
                                ${server.hashCode} - ${server.icon} 
                `;

                        // Append the server.jinja element to the server-list div
                        document.getElementById('server-list').appendChild(serverElement);
                    }
                }
            }, 1000);
        });

        document.getElementById('stop').addEventListener('click', function () {
            clearInterval(intervalId);
        });


    </script>
    <div id="server-list"></div>
</body>

</html>