<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>K8s Client</title>
    <link href="/static/css/fontawesome.css" rel="stylesheet" />
    <link href="/static/css/solid.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>

<body class="container">
    <h1>
        JustIcons Dashboard
    </h1>

    <style>
        #all-nodes {
            display: grid;
            grid-template-columns: repeat(6, 200px);
            row-gap: 28px;
            column-gap: 10px;
        }

        .fa-solid {
            width: 18.75px;
            text-align: center;
            font-size: large;
        }

        .node-obj-box>div {
            border: 1px solid red;
            height: 100px;
            width: 160px;
            padding: 0px;
            margin: 0px 4px;
        }

        .node-obj-box>span {
            width: 160px;
        }

        .node-obj {
            font-family: 'Droid Sans Mono';
        }

        .label {
            padding: 10px;
            font-size: 15px;
            border-radius: 0.45em;
            height: 44px;
            color: white;
            display: block;
            margin: 6px 0px;
        }

        .center {
            margin: auto;
            display: block;
            width: 50%;
            text-align: center;
        }

        .region-box-label {
            font-size: 18px;
            font-weight: bold;
            color: white;
            background-color: navy;
            border-radius: 0.35em;
            line-height: 8px;
            height: 30px;
            padding: 10px;
            width: 160px;
            vertical-align: middle;
        }

        #all-nodes-div {
            width: 100%;
            height: 100%;
            margin: 20px 5px 20px 5px;
        }

        .region-box {
            display: grid;
            grid-template-columns: repeat(1, 200px);
            margin: 10px;
            border: black 1px solid;
            border-radius: 4px;
            align-content: center;
            padding: 10px 10px;
        }

        #all-nodes {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
    </style>

    <div>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
    </div>

    <div>
        <!-- text boxes adjustable with mouse key that set number of servers, interval, and buffer time -->
        <label for="intervalTime">Interval time</label>
        <input type="number" id="intervalTime" name="intervalTime" value="2">
        <label for="batchSize">Batch size</label>
        <input type="number" id="batchSize" name="batchSize" value="5">
    </div>

    <div id="all-nodes-div">
        <div id="all-nodes">
        </div>
    </div>

    <script>
        // Query the given endpoint for the server data
        var hostname = "justicons.org";

        // A list of server objects that will be updated by the query
        // The server object looks like this:
        // {color: '#6638f0', hostname: 'M2-Max.local', icon: 'fa-phone-square-alt', iconID: 'node-number-M2-Max.local-icon', ip: '127.0.0.1'}
        var servers = {};
        // create a new worker thread
        worker = new Worker("/static/httpworker.js")
        worker.onmessage = (event) => {
            updateInnerLoop(event.data)
            var intervalTime = document.getElementById('intervalTime').value;

            // Wait for the interval to update the next server
            window.setTimeout(requestLoop, intervalTime);
        }


        var intervalTime = 2;
        var batchSize = 10;
        var stopLoop = false;

        // Create function to request data from the server
        function requestLoop() {
            if (stopLoop) {
                return;
            }
            var batchSize = document.getElementById('batchSize').value;
            // pass data to worker thread
            for (i = 0; i < batchSize; i++) {
                worker.postMessage(hostname)
            }
        }

        function updateInnerLoop(data) {
            if (data) {
                servers[data.hostname] = data
                var server = data;
                var hashCode = server.hashCode;

                var regionBox = $('#region-' + server.region);
                if (regionBox.length == 0) {
                    $('#all-nodes').append(" \
<div class='region-box-container' id='region-container-" + server.region + "'> \
<span class='region-box-label center'> " + server.region + "</span>\
<div class='region-box' id='region-" + server.region + "'> \
</div> \
</div>")
                    regionBox = $('#region-' + server.region);
                }


                var nodeName = "node-" + hashCode;
                if ($('#' + nodeName).length == 0) {
                    regionBox.append(" \
                <div class='node-obj-box'> \
                <span class='label label-info node-obj' id='"+ nodeName + "' \
                style='background-color: "+ server.color + "; border-color: " + server.color + "; border-style: solid;' \
                data-ip='"+ hashCode + "'> \
                "+ server.nodeID + " <span id='node-" + hashCode + "-icon' \
                class='fa-solid "+ server.icon + "'></span> \
                </span> \
                </div>");
                }
                else {
                    if ($("#" + nodeName + "-icon").attr('class') != "fa-solid " + server.icon) {
                        $("#" + nodeName).css("background-color", server.color)
                            .finish()
                            .css("border-color", server.color)
                            .css("color", "#FFFFFF")
                            .fadeTo(0, 0.50)
                            .fadeTo(200, 1)
                        $("#" + nodeName + "-icon").removeClass().toggleClass("fa-solid " + server.icon);
                    }
                }
            }
        }

        document.getElementById('start').addEventListener('click', function () {
            stopLoop = false;
            window.setTimeout(requestLoop, intervalTime);
        });

        document.getElementById('stop').addEventListener('click', function () {
            worker.terminate();
            stopLoop = true;
        });

        document.getElementById("updateTime").addEventListener('change', function (e) {
            timing = parseInt(this.value);
        });
    </script>
    <div id="server-list"></div>
</body>

</html>