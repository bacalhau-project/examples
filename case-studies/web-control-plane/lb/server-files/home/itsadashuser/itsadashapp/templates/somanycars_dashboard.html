<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>K8s Client</title>
    <link href="/static/css/fontawesome.css" rel="stylesheet" />
    <link href="/static/css/solid.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link href="http://fonts.googleapis.com/css?family=Droid+Sans+Mono" rel="stylesheet" type="text/css" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="/static/workerpool.min.js"></script>
    <script src="/static/socket.io.min.js"></script>
</head>

<body class="body">
    <h1>
        So Many Cars Dashboard
    </h1>

    <link rel="stylesheet" href="/static/css/somanycars_dashboard.css">

    <div>
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <input id="timeOutValue" type="number" value="200">
        <input id="batchSize" type="number" value="3">
    </div>

    <div>
    </div>

    <div class="all-nodes-container container">
        <div id="all-nodes" class="row">
            <!-- Node containers will be dynamically added here -->
        </div>
    </div>

    <div id="websocket-status">
        <h3 id="websocket-header"></h3>
    </div>

    <script>
        // Query the given endpoint for the server data
        var hostname = "somanycars.org";
        domParser = new DOMParser();


        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        const socket = io(); //socketio connection to server
        $(document).ready(function () {
        });
        socket.on("connect", () => {
            console.log("connected - somanycars");
            var header = document.getElementById("websocket-header");
            header.innerHTML = "<h3>" + "Websocket Connected" + "</h3>";
            header.style.color = "green";
        });

        socket.on("disconnect", () => {
            console.log("disconnected - somanycars");
            var header = document.getElementById("websocket-header")
            header.innerHTML = "<h3>" + "Websocket Disconnected" + "</h3>";
            header.style.color = "red";
        });

        var updateSet = new Set();

        // Event sent by Server//
        socket.on("node", function (msg) {
            let nodeData = JSON.parse(msg);
            updateSet.add(nodeData);
        });

        // An event loop that goes through the updateSet every timeOutValue milliseconds and takes
        // one object off the set. Runs forever.
        async function updateLoop() {
            while (true) {
                var timeOutValue = document.getElementById("timeOutValue").value;
                var batchSize = document.getElementById("batchSize").value;
                for (i = 0; i < batchSize; i += 1) {
                    if (updateSet.size > 0) {
                        var nodeData = updateSet.values().next().value;
                        updateSet.delete(nodeData);
                        updateInnerLoop(nodeData);
                    }
                }
                await sleep(timeOutValue);
            }
        }

        updateLoop();

        var servers = {};
        var pool = workerpool.pool('/static/httpworker.js', { maxWorkers: 10 });

        let dataQueue = []; // Queue to hold fetched data

        function updateInnerLoop(data) {
            if (data) {
                servers[data.hostname] = data;
                var server = data;
                var hashCode = server.hashCode;
                var nodeContainerID = 'node-container-' + server.hashCode;

                createOrUpdateNodeContainer(nodeContainerID, data);
            }
        }

        document.getElementById('start').addEventListener('click', function () {
            socket.emit("start_somanycars_socket", { data: "start" }, function () {
                ;
            });
        });

        document.getElementById('stop').addEventListener('click', function () {
            socket.emit("stop_somanycars_socket", function () {
            });
        });

        // When browser refresh or close, disconnect the socket
        window.onbeforeunload = function () {
            socket.disconnect();
        };

        var updateSet = new Set();

        // Event sent by Server//
        socket.on("node", function (msg) {
            let nodeData = JSON.parse(msg);
            updateSet.add(nodeData);
        });

        function createOrUpdateNodeContainer(nodeContainerID, nodeData) {

            // Check if the camera box already exists
            var nodeContainer = document.getElementById(nodeContainerID);

            // If the camera box doesn't exist, create it
            if (!nodeContainer) {
                let nodeContainerTemplateURL = '/static/node_container_template.html';
                // Get from the nodeContainerTemplateURL and await the response until it is received
                $.get(nodeContainerTemplateURL, function (data) {
                    if (document.getElementById(nodeContainerID)) {
                        // Node container already exists, update the container if it's not null and return
                        if (nodeData) {
                            updateNodeContainer(nodeContainer, nodeData);
                        }
                        return;
                    }
                    // Convert the response to a jQuery object
                    let rawTemplateBody = domParser.parseFromString(data, 'text/html');
                    let nodeDiv = rawTemplateBody.querySelector('#node-container-ID_NOT_SET');
                    nodeDiv.id = nodeContainerID;
                    $('#all-nodes').append(nodeDiv);
                }).then(() => {
                    // Get the newly created node container
                    updateNodeContainer(nodeContainerID, nodeData);
                });
            } else {
                // Update the existing node container
                updateNodeContainer(nodeContainerID, nodeData);
            }
        }
        function updateNodeContainer(nodeContainerID, nodeData) {
            if (!nodeContainerID) {
                console.log('Invalid node container ID:', nodeContainerID);
                return;
            }

            if (!nodeData) {
                console.log('Invalid node data:', nodeData);
                return;
            }

            var nc = $("#" + nodeContainerID);
            // If the video-feed url is different from the current one, update the video feed
            if (nc.find(".video-feed").attr("src") !== nodeData.video_feed) {
                nc.find(".video-feed").attr("src", nodeData.video_feed);
            }

            // Update hostname and hashcode if they are different
            nc.find(".hostname").text(nodeData.hostname);
            nc.find(".nodeID").text(nodeData.hashCode);

            dataToDisplay = ['external_ip',
                'region',
                'zone',
                'model_weights',
                'source_video_path',
                'confidence_threshold',
                'frames_processed_per_clip',
                'skip_frames']

            for (var i = 0; i < dataToDisplay.length; i++) {
                var dataElement = dataToDisplay[i];
                var element = nc.find("." + dataElement);
                dataToDisplayElement = nodeData[dataElement];
                if (dataElement == 'source_video_path') {
                    dataToDisplayElement = nodeData[dataElement].split('/').pop();
                }
                element.text(dataToDisplayElement);
            }
            nc.find(".last-inference-time").text(nodeData.last_inference_time);
            nc.find(".config-last-update").text(nodeData.config_last_update);

            // Define detection classes with their respective IDs and descriptions
            const vehicleClasses = {
                2: { label: "Cars", count: 0, trackers: [] },
                7: { label: "Trucks", count: 0, trackers: [] }
            };

            // Populate detections from node data
            var detections = [];
            Object.values(nodeData.total_detections || {}).forEach(detection => detections.push(detection));

            var detectionsContainer = nc.find(".total-detections-container");
            detectionsContainer.empty();  // Clear previous detections

            // Process and classify detections
            detections.forEach(function (detection) {
                let vehicleClass = vehicleClasses[detection.class_id];
                if (vehicleClass) {
                    vehicleClass.count++;
                    vehicleClass.trackers.push(detection.tracker_id);
                }
            });

            // Display information for each vehicle class
            Object.values(vehicleClasses).forEach(function (vc) {
                if (vc.count > 0) {
                    detectionsContainer.append(`<div><strong>${vc.label}:</strong> ${vc.count}<br>IDs: ${vc.trackers.join(", ")}</div>`);
                } else {
                    detectionsContainer.append(`<div><strong>${vc.label}:</strong> None detected</div>`);
                }
            });

            // Handle case where no detections are present
            if (Object.values(vehicleClasses).length === 0) {
                detectionsContainer.append("<div><strong>None Found</strong></div>");
            }
        }

    </script>
    <div id="server-list"></div>
</body>

</html>