# Event Puller justfile
# Usage: 
# - just build_binary           # Build the binary
# - just run_binary             # Run the binary locally
# - just build_container        # Build the Docker container
# - just run_container          # Run the Docker container

# Default variables
registry := "docker.io"
organization := "bacalhauproject"
image_name := "event-puller"
timestamp := `date +%Y%m%d%H%M`
host_port := "8080"
container_port := "8080"
env_file := ".env"  # Default env file path

# Build the Go binary
build_binary:
    @echo "ğŸ› ï¸  Building event-puller binary..."
    @mkdir -p bin
    go build -o bin/event-puller
    @echo "âœ… Binary built at bin/event-puller"

# Run the binary locally with environment variables from .env file
# Usage:
#   just run_binary                      # Use default .env file
#   just env_file=custom.env run_binary  # Use custom env file
run_binary:
    @echo "ğŸš€ Running event-puller locally..."
    just build_binary
    @if [ ! -f "{{env_file}}" ]; then \
        if [ "{{env_file}}" = ".env" ] && [ -f ".env.example" ]; then \
            echo "âš ï¸  No {{env_file}} file found. Using .env.example as a template..."; \
            cp .env.example {{env_file}}; \
            echo "âš ï¸  Please edit {{env_file}} file with your actual credentials"; \
        else \
            echo "âŒ Environment file {{env_file}} not found and no template available"; \
            exit 1; \
        fi; \
    fi
    @echo "ğŸ“‹ Press Ctrl+C to stop"
    @echo "ğŸ“„ Using environment file: {{env_file}}"
    ENV_FILE={{env_file}} ./bin/event-puller

# Build the dashboard and the Docker container
build_container:
    @echo "ğŸ”¨ Building event-puller container..."
    @# Build dashboard if Node.js is available
    @if command -v node > /dev/null && command -v npm > /dev/null; then \
        if [ -d "dashboard" ] && [ -f "dashboard/package.json" ]; then \
            echo "ğŸ“Š Building Next.js dashboard..."; \
            cd dashboard && npm install && npm run build; \
            cd ..; \
        else \
            echo "âš ï¸  Dashboard directory or package.json not found, skipping dashboard build"; \
        fi \
    else \
        echo "âš ï¸  Node.js or npm not found, skipping dashboard build"; \
    fi
    
    @# Build binary for Linux
    @echo "ğŸ”§ Building Go binary for container..."
    CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build -ldflags="-s -w" -o bin/event-puller
    
    @# Compress with UPX if available
    @if command -v upx > /dev/null; then \
        echo "ğŸ“¦ Compressing binary with UPX..."; \
        upx --best --lzma bin/event-puller; \
    fi
    
    @# Build Docker image
    @echo "ğŸ³ Building Docker image..."
    docker build --platform linux/amd64 -t "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}" .
    docker tag "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}" "{{registry}}/{{organization}}/{{image_name}}:latest"
    @echo "âœ… Container built: {{registry}}/{{organization}}/{{image_name}}:{{timestamp}}"
    @echo "âœ… Also tagged as: {{registry}}/{{organization}}/{{image_name}}:latest"

# Run the container locally using local .env file
# Usage: 
#   just run_container                                # Use default settings
#   just env_file=custom.env run_container            # Use custom env file
#   just host_port=3000 container_port=8080 run_container  # Use custom ports
run_container: 
    @echo "ğŸš€ Running event-puller in container..."
    @if ! docker image inspect {{registry}}/{{organization}}/{{image_name}}:latest >/dev/null 2>&1; then \
        echo "âŒ Container image not found. Building first..."; \
        just build_container; \
    fi
    @if [ ! -f "{{env_file}}" ]; then \
        if [ "{{env_file}}" = ".env" ] && [ -f ".env.example" ]; then \
            echo "âš ï¸  No {{env_file}} file found. Using .env.example as a template..."; \
            cp .env.example {{env_file}}; \
            echo "âš ï¸  Please edit {{env_file}} file with your actual credentials"; \
        else \
            echo "âŒ Environment file {{env_file}} not found and no template available"; \
            exit 1; \
        fi; \
    fi
    @echo "ğŸ“‹ Press Ctrl+C to stop"
    @echo "ğŸ“Š Dashboard will be available at http://localhost:{{host_port}}"
    @echo "ğŸ“„ Using environment file: {{env_file}}"
    docker run --rm -p {{host_port}}:{{container_port}} \
        --env-file {{env_file}} \
        -v $(pwd)/{{env_file}}:/app/.env \
        -e ENV_FILE=/app/.env \
        {{registry}}/{{organization}}/{{image_name}}:latest

# Push the container to registry
push_container:
    @echo "ğŸš¢ Pushing container to registry..."
    docker push "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}"
    docker push "{{registry}}/{{organization}}/{{image_name}}:latest"
    @echo "âœ… Container pushed to registry"

# Build the Next.js dashboard
build_dashboard:
    @echo "ğŸ“Š Building dashboard..."
    @if [ ! -d "dashboard" ] || [ ! -f "dashboard/package.json" ]; then \
        echo "âŒ Dashboard directory or package.json not found"; \
        exit 1; \
    fi
    cd dashboard && npm install && npm run build
    @echo "âœ… Dashboard built"

# Run the dashboard in development mode
dev_dashboard:
    @echo "ğŸš€ Running dashboard in development mode..."
    @if [ ! -d "dashboard" ] || [ ! -f "dashboard/package.json" ]; then \
        echo "âŒ Dashboard directory or package.json not found"; \
        exit 1; \
    fi
    cd dashboard && npm install && npm run dev