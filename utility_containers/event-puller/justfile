# Event Puller justfile
# Usage: 
# - just build_binary           # Build the binary
# - just run_binary             # Run the binary locally
# - just build_container        # Build the Docker container
# - just run_container          # Run the Docker container

# Default variables
registry := "docker.io"
organization := "bacalhauproject"
image_name := "event-puller"
timestamp := `date +%Y%m%d%H%M`
host_port := "8080"
container_port := "8080"
env_file := ".env"  # Default env file path
debug := "false"    # Set to "true" for verbose debugging

# Build the Go binary
build_binary:
    @echo "🛠️  Building event-puller binary..."
    @mkdir -p bin
    go build -o bin/event-puller
    @echo "✅ Binary built at bin/event-puller"

# Run the binary locally with environment variables from .env file
# Usage:
#   just run_binary                      # Use default .env file
#   just env_file=custom.env run_binary  # Use custom env file
run_binary:
    @echo "🚀 Running event-puller locally..."
    just build_binary
    @if [ ! -f "{{env_file}}" ]; then \
        if [ "{{env_file}}" = ".env" ] && [ -f ".env.example" ]; then \
            echo "⚠️  No {{env_file}} file found. Using .env.example as a template..."; \
            cp .env.example {{env_file}}; \
            echo "⚠️  Please edit {{env_file}} file with your actual credentials"; \
        else \
            echo "❌ Environment file {{env_file}} not found and no template available"; \
            exit 1; \
        fi; \
    fi
    @echo "📋 Press Ctrl+C to stop"
    @echo "📄 Using environment file: {{env_file}}"
    ENV_FILE={{env_file}} ./bin/event-puller

# Build the dashboard and the Docker container
build_container:
    @echo "🔨 Building event-puller container..."
    @# Build dashboard if Node.js is available
    @if command -v node > /dev/null && command -v npm > /dev/null; then \
        if [ -d "dashboard" ] && [ -f "dashboard/package.json" ]; then \
            echo "📊 Building Next.js dashboard..."; \
            cd dashboard && npm install && npm run build; \
            cd ..; \
        else \
            echo "⚠️  Dashboard directory or package.json not found, skipping dashboard build"; \
        fi \
    else \
        echo "⚠️  Node.js or npm not found, skipping dashboard build"; \
    fi
    
    @# Build binary for Linux
    @echo "🔧 Building Go binary for container..."
    CGO_ENABLED=0 GOARCH=amd64 GOOS=linux go build -ldflags="-s -w" -o bin/event-puller
    
    @# Compress with UPX if available
    @if command -v upx > /dev/null; then \
        echo "📦 Compressing binary with UPX..."; \
        upx --best --lzma bin/event-puller; \
    fi
    
    @# Build Docker image
    @echo "🐳 Building Docker image..."
    docker build --platform linux/amd64 -t "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}" .
    docker tag "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}" "{{registry}}/{{organization}}/{{image_name}}:latest"
    @echo "✅ Container built: {{registry}}/{{organization}}/{{image_name}}:{{timestamp}}"
    @echo "✅ Also tagged as: {{registry}}/{{organization}}/{{image_name}}:latest"

# Run the container locally using local .env file
# Usage: 
#   just run_container                                # Use default settings
#   just env_file=custom.env run_container            # Use custom env file
#   just host_port=3000 container_port=8080 run_container  # Use custom ports
#   just debug=true run_container                     # Run with verbose debugging
run_container: 
    @echo "🚀 Running event-puller in container..."
    @if ! docker image inspect {{registry}}/{{organization}}/{{image_name}}:latest >/dev/null 2>&1; then \
        echo "❌ Container image not found. Building first..."; \
        just build_container; \
    fi
    @if [ ! -f "{{env_file}}" ]; then \
        if [ "{{env_file}}" = ".env" ] && [ -f ".env.example" ]; then \
            echo "⚠️  No {{env_file}} file found. Using .env.example as a template..."; \
            cp .env.example {{env_file}}; \
            echo "⚠️  Please edit {{env_file}} file with your actual credentials"; \
        else \
            echo "❌ Environment file {{env_file}} not found and no template available"; \
            exit 1; \
        fi; \
    fi
    @echo "📋 Press Ctrl+C to stop"
    @echo "📊 Dashboard will be available at http://localhost:{{host_port}}"
    @echo "📄 Using environment file: {{env_file}}"
    
    # Create a simple shell script to extract variables correctly
    @cat > .extract_vars.sh << 'EOF'
    #!/bin/sh
    ENV_FILE="$1"
    set -a  # Auto-export all variables
    if [ -f "$ENV_FILE" ]; then
       . "$ENV_FILE"  # Source the env file
    fi
    EOF
    @chmod +x .extract_vars.sh
    
    # Extract all variables from the environment file
    @eval $(./.extract_vars.sh "{{env_file}}")
    
    # When debug is enabled, show what we're doing
    @if [ "{{debug}}" = "true" ]; then \
        echo "🔍 Debug info:"; \
        echo "  AWS_REGION=$${AWS_REGION}"; \
        echo "  SQS_QUEUE_URL=$${SQS_QUEUE_URL} (truncated)"; \
        echo "  AWS_ACCESS_KEY_ID=$${AWS_ACCESS_KEY_ID:0:5}... (truncated for security)"; \
        echo "  Container: {{registry}}/{{organization}}/{{image_name}}:latest"; \
        echo "  Port mapping: {{host_port}}:{{container_port}}"; \
    fi
    
    # Run with these explicit environment variables
    docker run --rm -p {{host_port}}:{{container_port}} \
        -e AWS_ACCESS_KEY_ID="$${AWS_ACCESS_KEY_ID}" \
        -e AWS_SECRET_ACCESS_KEY="$${AWS_SECRET_ACCESS_KEY}" \
        -e AWS_REGION="$${AWS_REGION}" \
        -e SQS_QUEUE_URL="$${SQS_QUEUE_URL}" \
        {{registry}}/{{organization}}/{{image_name}}:latest

# Push the container to registry
push_container:
    @echo "🚢 Pushing container to registry..."
    docker push "{{registry}}/{{organization}}/{{image_name}}:{{timestamp}}"
    docker push "{{registry}}/{{organization}}/{{image_name}}:latest"
    @echo "✅ Container pushed to registry"

# Build the Next.js dashboard
build_dashboard:
    @echo "📊 Building dashboard..."
    @if [ ! -d "dashboard" ] || [ ! -f "dashboard/package.json" ]; then \
        echo "❌ Dashboard directory or package.json not found"; \
        exit 1; \
    fi
    cd dashboard && npm install && npm run build
    @echo "✅ Dashboard built"

# Run the dashboard in development mode
dev_dashboard:
    @echo "🚀 Running dashboard in development mode..."
    @if [ ! -d "dashboard" ] || [ ! -f "dashboard/package.json" ]; then \
        echo "❌ Dashboard directory or package.json not found"; \
        exit 1; \
    fi
    cd dashboard && npm install && npm run dev