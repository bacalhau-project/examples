name: bacalhau-edge

x-common-env-variables: &common-env-variables
  BACALHAU_DISABLEANALYTICS: true
  LOG_LEVEL: debug

services:
  edge-us:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=us,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "us"
    deploy:
      replicas: ${REPLICAS:-3}
      resources:
        limits:
          cpus: "0.03" # 3% of a CPU core
          memory: "200M" # 200MB per service
    networks:
      - bacalhau-network

  edge-eu:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=eu,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "eu"
    deploy:
      replicas: ${REPLICAS:-3}
      resources:
        limits:
          cpus: "0.1" # 10% of a CPU core (enough for 20 jobs at 0.001 each)
          memory: "400M" # 400MB (enough for 10 jobs at 36MB each, plus overhead)
    networks:
      - bacalhau-network

  edge-as:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=as,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "as"
    deploy:
      replicas: ${REPLICAS:-3}
      resources:
        limits:
          cpus: "0.1" # 10% of a CPU core (enough for 20 jobs at 0.001 each)
          memory: "400M" # 400MB (enough for 10 jobs at 36MB each, plus overhead)
    networks:
      - bacalhau-network

  sqs-proxy:
    image: ghcr.io/bacalhau-project/wasm-sensors-sqs-proxy:latest
    environment:
      <<: *common-env-variables
      AWS_ACCESS_KEY_ID: "$AWS_ACCESS_KEY_ID"
      AWS_SECRET_ACCESS_KEY: "$AWS_SECRET_ACCESS_KEY"
      AWS_REGION: "$AWS_REGION"
      SQS_QUEUE_URL: "$SQS_QUEUE_URL"
      BACALHAU_PORT_http: "9090"
    networks:
      - bacalhau-network
    ports:
      - "9090:9090"

  client:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: /bin/sh
    stdin_open: true
    tty: true
    stop_signal: SIGTERM
    stop_grace_period: 3s
    environment:
      <<: *common-env-variables
      BACALHAU_API_HOST: 20.82.178.246
    networks:
      - bacalhau-network

networks:
  bacalhau-network:
