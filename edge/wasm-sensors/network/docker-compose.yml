name: bacalhau-edge

x-common-env-variables: &common-env-variables
  BACALHAU_DISABLEANALYTICS: true
  LOG_LEVEL: info

services:
  orchestrator:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    hostname: orchestrator
    command: serve -c /etc/bacalhau/config.yaml --name orchestrator
    environment: *common-env-variables
    # Using host network mode
    network_mode: "host"
    volumes:
      - ./config/orchestrator.yaml:/etc/bacalhau/config.yaml
    deploy:
      resources:
        reservations:
          cpus: "2.0"
          memory: "4G"
    healthcheck:
      test: ["CMD", "bacalhau", "agent", "alive"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 15s

  web-services:
    image: ghcr.io/bacalhau-project/bacalhau:latest-dind
    hostname: web-services
    command: serve -c /etc/bacalhau/config.yaml -c labels=type=web-services
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
    environment:
      <<: *common-env-variables
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
    depends_on:
      orchestrator:
        condition: service_healthy
    privileged: true
    network_mode: "host"

  edge-us:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=us,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "us"
    depends_on:
      orchestrator:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.03" # 3% of a CPU core
          memory: "200M" # 200MB per service
    network_mode: "host"

  edge-eu:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=eu,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "eu"
    depends_on:
      orchestrator:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.03" # 3% of a CPU core
          memory: "200M" # 200MB per service
    network_mode: "host"

  edge-as:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: sh
    command: -c 'mkdir -p /app && bacalhau serve -c /etc/bacalhau/config.yaml -c labels=region=as,type=edge'
    volumes:
      - ./config/compute.yaml:/etc/bacalhau/config.yaml
      - ./modules:/app/modules
    environment:
      <<: *common-env-variables
      REGION: "as"
    depends_on:
      orchestrator:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.03" # 3% of a CPU core
          memory: "200M" # 200MB per service
    network_mode: "host"

  sqs-proxy:
    image: ghcr.io/bacalhau-project/wasm-sensors-sqs-proxy:latest
    environment:
      <<: *common-env-variables
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      AWS_REGION: "${AWS_REGION}"
      SQS_QUEUE_URL: "${SQS_QUEUE_URL}"
      BACALHAU_PORT_http: "9090"
    # Using host network mode
    network_mode: "host"

  sqs-puller:
    image: ghcr.io/bacalhau-project/event-puller:latest
    environment:
      <<: *common-env-variables
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
      AWS_REGION: "${AWS_REGION}"
      SQS_QUEUE_URL: "${SQS_QUEUE_URL}"
      ENV_FILE: /app/.env
    volumes:
      - ./.env:/app/.env
    # Using host network mode
    network_mode: "host"

  client:
    image: ghcr.io/bacalhau-project/bacalhau:latest
    entrypoint: /bin/sh
    stdin_open: true
    tty: true
    stop_signal: SIGTERM
    stop_grace_period: 3s
    environment:
      <<: *common-env-variables
    depends_on:
      - orchestrator
    network_mode: "host"
