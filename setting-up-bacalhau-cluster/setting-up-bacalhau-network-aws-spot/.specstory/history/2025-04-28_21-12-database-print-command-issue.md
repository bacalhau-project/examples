<!-- Generated by SpecStory -->

# Database Print Command Issue (2025-04-28 14:12:26)

_**User**_

why is the table printing out twice when i do print-database

---

_**Assistant**_



---

```python
async def main():
    global table_update_running
    table_update_running = False

    # Check AWS SSO token first
    if not check_aws_sso_token():
        return 1

    logger.debug("Starting main execution")
    parser = argparse.ArgumentParser(
        description="Manage spot instances across multiple AWS regions."
    )
    parser.add_argument(
        "--action",
        choices=[
            "create",
            "destroy",
            "list",
            "print-database",
        ],
        help="Action to perform",
        default="list",
    )
    parser.add_argument(
        "--format", choices=["default", "json"], default="default", help="Output format"
    )
    parser.add_argument(
        "--overwrite", action="store_true", help="Overwrite database if it exists"
    )
    args = parser.parse_args()

    # Keep track if print-database was the main action
    print_db_action = args.action == "print-database"

    try:
        # Log the action being performed at INFO level for better visibility
        action_msg = f"Starting {args.action} operation..."
        logger.info(action_msg)
        log_operation(action_msg)

        # Load existing machine state
        log_operation("Loading machine state...")
        machines = await machine_state.load()

        if args.action == "print-database":
            print_machines_table()
            return 0 # Exit here for print-database action

        # For 'create' action, check if database exists and would be overwritten
        if args.action == "create" and not args.overwrite:
            can_proceed = await machine_state.check_existing_file(
                overwrite=args.overwrite
            )
            if not can_proceed:
                logger.error(
                    "Cannot proceed with create operation - database already contains instances"
                )
                log_operation(
                    "Cannot proceed without --overwrite flag when database contains instances",
                    "error",
                )
                return 1

        # Report valid AWS instances
        valid_count = machine_state.count()
        print(f"Loaded {valid_count} valid AWS instances from database")
        log_operation(f"Found {valid_count} valid AWS instances in database")

        with Live(console=console, refresh_per_second=4, screen=True) as live:
            update_task = asyncio.create_task(update_table(live))

            try:
                if args.action == "list":
                    log_operation("Starting 'list' action")
                    await list_spot_instances()
                    # Ensure table is visible
                    await update_table_now()
                    await asyncio.sleep(1)
                    log_operation("List action completed successfully")
                elif args.action == "create":
                    log_operation("Starting 'create' action")
                    await create_spot_instances()
                    # Ensure table is visible
                    await update_table_now()
                    await asyncio.sleep(1)
                    log_operation("Create action completed successfully")
                elif args.action == "destroy":
                    log_operation("Starting 'destroy' action")
                    await destroy_instances()
                    log_operation("Destroy action completed successfully")

                logger.debug("Action %s completed successfully", args.action)
                logger.debug("Main execution completed successfully")
                logger.info("Operation completed successfully")

                # Give time for final table update to be visible
                if args.action in ["list", "create"]:
                    await asyncio.sleep(2)

            finally:
                # Stop the table update task
                table_update_event.set()
                await update_task

    except Exception as e:
        logger.exception("Error in main execution")
        log_operation(f"Operation failed: {str(e)}", "error")
        return 1
    finally:
        # Cleanup phase
        logger.debug("Cleaning up and shutting down")
        logger.info("Cleaning up...")

        if args.action in ["list", "create"]:
            logger.info(f"Completed {args.action} operation successfully")

        # Only print the table here if the action wasn't print-database
        if not print_db_action:
             print_machines_table()

        logger.debug("Script completed successfully")

    return 0
```


---



---

